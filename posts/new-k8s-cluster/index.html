<!DOCTYPE html>
<html><head>
<title>在云上自建Kubernetes集群</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">















  






      <script src="/js/toc.js"></script>
    
    <link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">

<link rel="stylesheet" href="/scss/dark-mode.min.cb53f1bee2b8900cb4f082afbf00175d6618f281cf9a2fe8619e3b52d20b5721.css" integrity="sha256-y1PxvuK4kAy08IKvvwAXXWYY8oHPmi/oYZ47UtILVyE=" media="screen">


<link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Material+Icons">



















</head>
<body>
    	<div id="app"><div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                    
                
                
                
                <a class="a-block drawer-menu-item active" href="/posts">
                    Archive
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/categories">
                    Categories
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/tags">
                    Tags
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/index.xml">
                    RSS Feed
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%ae%89%e8%a3%85%e8%83%8c%e6%99%af" class="nav-安装背景">
									安装背景
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e8%8a%82%e7%82%b9" class="nav-初始化节点">
									初始化节点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%ae%89%e8%a3%85kubectlkubeadmkubelet-%e7%bb%84%e4%bb%b6" class="nav-安装kubectlkubeadmkubelet-组件">
									安装kubectl、kubeadm、kubelet 组件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%ae%89%e8%a3%85-containerd" class="nav-安装-containerd">
									安装 containerd
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bf%ae%e6%94%b9containerd-%e4%b8%ad%e7%9a%84-sandbox-image%e9%85%8d%e7%bd%ae" class="nav-修改containerd-中的-sandbox-image配置">
									修改containerd 中的 sandbox image配置：
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%b7%bb%e5%8a%a0-crictl%e9%85%8d%e7%bd%ae" class="nav-添加-crictl配置">
									添加 crictl配置
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%ae%89%e8%a3%85-%e5%b9%b6%e9%85%8d%e7%bd%ae-cni-%e6%8f%92%e4%bb%b6" class="nav-安装-并配置-cni-插件">
									安装 并配置 cni 插件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%86%85%e6%a0%b8%e5%8f%82%e6%95%b0%e9%85%8d%e7%bd%ae%e4%bf%ae%e6%94%b9" class="nav-内核参数配置修改">
									内核参数配置修改
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%9b%86%e7%be%a4%e5%88%9d%e5%a7%8b%e5%8c%96--%e5%8a%a0%e5%85%a5master%e8%8a%82%e7%82%b9" class="nav-集群初始化--加入master节点">
									集群初始化–加入master节点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8a%a0%e5%85%a5worker%e8%8a%82%e7%82%b9" class="nav-加入worker节点">
									加入worker节点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#master%e8%8a%82%e7%82%b9%e7%9a%84%e6%b7%bb%e5%8a%a0%e5%8f%8a%e4%b8%80%e4%ba%9b%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" class="nav-master节点的添加及一些注意事项">
									master节点的添加及一些注意事项
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#discovery-token-ca-cert-hash-%e5%af%b9%e5%ba%94%e7%9a%84%e5%80%bc%e5%8f%af%e4%bb%a5%e9%80%9a%e8%bf%87%e5%a6%82%e4%b8%8b%e5%91%bd%e4%bb%a4%e8%8e%b7%e5%8f%96" class="nav-discovery-token-ca-cert-hash-对应的值可以通过如下命令获取">
									discovery-token-ca-cert-hash 对应的值可以通过如下命令获取：
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%af%81%e4%b9%a6%e7%9b%b8%e5%85%b3%e4%b8%80%e4%ba%9b%e5%91%bd%e4%bb%a4%e5%a4%87%e5%bf%98" class="nav-证书相关一些命令备忘">
									证书相关一些命令备忘：
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" class="nav-参考资料">
									参考资料
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://www.lix23.com">
            雪泥鸿爪
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://www.lix23.com">
        <div class="single-column-header-title">雪泥鸿爪</div>
        
        <div class="single-column-header-subtitle">日拱一卒，功不唐捐</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                
            >
                <div class="post-title">
                    在云上自建Kubernetes集群
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2023-11-14 23:13
                        </time>
                        

                        

                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <h2 id="安装背景">安装背景</h2>
<p>自建Kubernetes集群是指在阿里云上购买ECS并从头开始来完成kubernetes集群的安装与配置；集群ECS规格采用的最小规格安装，2c4G的突发实例，操作系统是Anolis OS 8.8 RHCK 64位；使用kubeadm这个工具来进行安装，主要流程可抽象成两个大步骤：
1、初始化节点：通过rpm包管理工具安装kubectl、kubelet、kubeadm 这几个组件；安装containerd，并完成相关配置；
2、初始化集群：注意kubeadm的配置文件，生成证书等配置，建立高可用控制面，并将worker节点加入集群中；</p>
<h2 id="初始化节点">初始化节点</h2>
<h3 id="安装kubectlkubeadmkubelet-组件">安装kubectl、kubeadm、kubelet 组件</h3>
<p>考虑到网络联通性问题，需要加入rpm包的国内本地化配置源，首先是kubernetes的源：添加rpm源的配置如下所示，清注意关闭gpgcheck</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF |tee /etc/yum.repos.d/kubernetes.repo
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">[kubernetes]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">name=Kubernetes
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">enabled=1
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">repo_gpgcheck=0
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>yum install kubectl kubeadm kubelet   不声明版本则安装具体的最新版；
</span></span></code></pre></div><h3 id="安装-containerd">安装 containerd</h3>
<p>contaienrd 配置</p>
<p>参考 <a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/#containerd">https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/#containerd</a> 来进行containerd的安装</p>
<p>containerd 国内本地化源配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
</span></span></code></pre></div><p>先验证contianerd包在源中存在，然后执行如下命令安装相关 containerd 运行时：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  yum install containerd.io
</span></span><span style="display:flex;"><span>  systemctl enable containerd
</span></span><span style="display:flex;"><span>  systemctl start containerd
</span></span></code></pre></div><h3 id="修改containerd-中的-sandbox-image配置">修改containerd 中的 sandbox image配置：</h3>
<p>containerd config default &gt; /etc/containerd/config.toml ，待相关配置文件生成以后，要 修改 sandbox image配置：registry.aliyuncs.com/google_containers/pause:3.9</p>
<p>配置修改后通过 systemctl restart containerd 命令重启生效配置，注意：</p>
<p>查看containerd当前生效配置：containerd config dump &gt; 2.toml；
如果containerd的工作状态不符合预期，可以通过 journalctl -xeu containerd 命令来查看containerd日志 ；</p>
<h3 id="添加-crictl配置">添加 crictl配置</h3>
<p>相关配置文件为 /etc/crictl.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF |tee /etc/crictl.yaml
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"># these first two endpoint setting is where you configure crictl to containerd
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">runtime-endpoint: unix:///run/containerd/containerd.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">image-endpoint: unix:///run/containerd/containerd.sock
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">timeout: 3
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">debug: true
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>此时执行 crictl images 可以正常输出内容；</p>
<h3 id="安装-并配置-cni-插件">安装 并配置 cni 插件</h3>
<p>在 cni 界面 <a href="https://github.com/containernetworking/plugins/releases">https://github.com/containernetworking/plugins/releases</a> ，找到 v1.3.0 或者v1.0.0 版本，通过wget命令下载此包。</p>
<p>通过命令创建cni的对应目录：mkdir -p /opt/cni/bin ，
通过如下相关命令将包解压至相关目录： tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.3.0.tgz</p>
<p>本地cni配置，注意版本号以及相关ip子网地址段：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>cat <span style="color:#e6db74">&lt;&lt; EOF | tee /etc/cni/net.d/10-containerd-net.conflist
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> &#34;cniVersion&#34;: &#34;1.0.0&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> &#34;name&#34;: &#34;containerd-net&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> &#34;plugins&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     &#34;type&#34;: &#34;bridge&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     &#34;bridge&#34;: &#34;cni0&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     &#34;isGateway&#34;: true,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     &#34;ipMasq&#34;: true,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     &#34;promiscMode&#34;: true,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     &#34;ipam&#34;: {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;type&#34;: &#34;host-local&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;ranges&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         [{
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">           &#34;subnet&#34;: &#34;10.14.0.0/24&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         }]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       ],
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       &#34;routes&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         { &#34;dst&#34;: &#34;0.0.0.0/0&#34; },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">         { &#34;dst&#34;: &#34;::/0&#34; }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">       ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   },
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     &#34;type&#34;: &#34;portmap&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     &#34;capabilities&#34;: {&#34;portMappings&#34;: true},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">     &#34;externalSetMarkChain&#34;: &#34;KUBE-MARK-MASQ&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">   }
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74"> ]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">EOF</span>
</span></span></code></pre></div><p>注意此时只解决了本节点上容器通信的问题，并未解决在节点间的容器通信问题，跨节点通信需要通过类似 flannel、calico 这样的方案来完成。</p>
<p>测试：通过crictl 成功run起来一个本地容器，参考crictl 相关文档；</p>
<h3 id="内核参数配置修改">内核参数配置修改</h3>
<p>内核参数设置（如果不做如下操作，将会无法通过 kubeadm init的 precheck ）</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># 修改域名配置 </span>
</span></span><span style="display:flex;"><span>hostnamectl set-hostname k8s-1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 安装tc </span>
</span></span><span style="display:flex;"><span>yum install iproute-tc
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sysctl: cannot stat /proc/sys/net/bridge/bridge-nf-call-iptables: No such file or directory 如果遇到相关错误，请执行 modprobe 命令</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> modprobe bridge
</span></span><span style="display:flex;"><span> modprobe br_netfilter
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> echo <span style="color:#e6db74">&#34;net.bridge.bridge-nf-call-iptables=1&#34;</span> | sudo tee -a /etc/sysctl.conf
</span></span><span style="display:flex;"><span> echo <span style="color:#e6db74">&#34;net.bridge.bridge-nf-call-iptables = 1&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span> echo <span style="color:#e6db74">&#34;net.bridge.bridge-nf-call-ip6tables = 1&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span> echo <span style="color:#e6db74">&#34;net.ipv4.ip_forward = 1&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span> echo <span style="color:#e6db74">&#34;vm.swappiness = 0&#34;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sysctl 使相关配置生效
</span></span><span style="display:flex;"><span>sysctl -p /etc/sysctl.conf
</span></span></code></pre></div><h3 id="集群初始化--加入master节点">集群初始化&ndash;加入master节点</h3>
<p>通过ssh登录一台预先规划好的master服务器，通过kubeadm 来完成节点初始化工作，注意给出config配置文件需要使用国内的镜像仓库；注意 &ndash;apiserver-advertise-address 为相关master服务器的内网地址；</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>kubeadm init <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --apiserver-advertise-address<span style="color:#f92672">=</span>192.168.0.121 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --image-repository registry.aliyuncs.com/google<span style="color:#ae81ff">\_</span>containers <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --kubernetes-version v1.28.2 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --service-cidr<span style="color:#f92672">=</span>10.1.0.0/16 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16
</span></span><span style="display:flex;"><span>  --config kubeadm.yaml
</span></span></code></pre></div><p>配置文件内容如下，注意certSANs中将三台master的hostname及ip地址都写入，此外还加入了api server对应LB的域名及ip地址：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiServer</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">certSANs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">api.k8s.local</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">api.lixin.com</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">master3105</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">master12</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">master079</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">10.0.3.105</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">10.0.1.2</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">10.0.0.79</span>
</span></span><span style="display:flex;"><span>  - <span style="color:#ae81ff">10.0.4.212</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">extraArgs</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">authorization-mode</span>: <span style="color:#ae81ff">Node,RBAC</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">timeoutForControlPlane</span>: <span style="color:#ae81ff">4m0s</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">kubeadm.k8s.io/v1beta3</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">certificatesDir</span>: <span style="color:#ae81ff">/etc/kubernetes/pki</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">clusterName</span>: <span style="color:#ae81ff">kube-lixin</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">controllerManager</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">dns</span>: {}
</span></span><span style="display:flex;"><span><span style="color:#f92672">etcd</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">local</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">dataDir</span>: <span style="color:#ae81ff">/var/lib/etcd</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">imageRepository</span>: <span style="color:#ae81ff">registry.aliyuncs.com/google_containers</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">ClusterConfiguration</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kubernetesVersion</span>: <span style="color:#ae81ff">v1.28.0</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">controlPlaneEndpoint</span>: <span style="color:#e6db74">&#34;10.0.4.212:6443&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">networking</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">dnsDomain</span>: <span style="color:#ae81ff">cluster.local</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">podSubnet</span>: <span style="color:#ae81ff">10.244.0.0</span><span style="color:#ae81ff">/16</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">serviceSubnet</span>: <span style="color:#ae81ff">10.96.0.0</span><span style="color:#ae81ff">/12</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scheduler</span>: {}
</span></span></code></pre></div><p>注意在kubeadm init 执行过程中的日志输出，如果日志不够细的话还可以加入 &ndash;v=10 参数并执行；</p>
<p>在其他两台master上，在完成节点初始化（本文第一部分）后，需要将相关kubernetes证书从最开始的master机器上拷贝出来：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>scp /etc/kubernetes/pki/etcd/ca.key root@10.0.1.2:/etc/kubernetes/pki/etcd                                                                            
</span></span><span style="display:flex;"><span>scp /etc/kubernetes/pki/etcd/ca.crt root@10.0.0.79:/etc/kubernetes/pki/etcd    
</span></span><span style="display:flex;"><span>scp /etc/kubernetes/pki/front-proxy-ca.key root@10.0.0.79:/etc/kubernetes/pki 
</span></span><span style="display:flex;"><span>scp /etc/kubernetes/pki/front-proxy-ca.crt root@10.0.0.79:/etc/kubernetes/pki
</span></span><span style="display:flex;"><span>scp /etc/kubernetes/pki/sa.pub root@10.0.0.79:/etc/kubernetes/pki
</span></span><span style="display:flex;"><span>scp /etc/kubernetes/pki/sa.key root@10.0.0.79:/etc/kubernetes/pki   
</span></span><span style="display:flex;"><span>scp /etc/kubernetes/pki/ca.key root@10.0.0.79:/etc/kubernetes/pki 
</span></span><span style="display:flex;"><span>scp /etc/kubernetes/pki/ca.crt root@10.0.0.79:/etc/kubernetes/pki
</span></span></code></pre></div><p>通过如下命令将此节点作为一个master加入集群，注意参数 &ndash;control-plane 这里说明是作为master进入的：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span> kubeadm join 10.0.3.105:6443 --token svy3br.1hcjfw953q23ypq3 --discovery-token-ca-cert-hash sha256:032c441fac7307da1867fab25ab77f480318c3ca68fb67977cd8011c3a4aab88 --control-plane
</span></span></code></pre></div><p>高可用集群控制面的两个问题：
1、需要提前完成证书在master实例节点之间的copy；
2、需要申请一个SLB将流量转发到多个api server 实例上，在 controlPlaneEndpoint 上体现了这个SLB的对应配置。</p>
<h3 id="加入worker节点">加入worker节点</h3>
<p>此刻可以说是完成了控制面 节点的搭建；通过如下命令将worker节点加入集群，注意worker节点并不需要提前scp证书，并且不需要 control-plane 参数；如果执行时日志中有 token 过期相关错误，需要登录到最初的master节点上，通过kubeadm token create创建一个新的token,并在&ndash;token 处使用新的token。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  kubeadm join 10.0.3.105:6443 --token svy3br.1hcjfw953q23ypq3 --discovery-token-ca-cert-hash sha256:032c441fac7307da1867fab25ab77f480318c3ca68fb67977cd8011c3a4aab88 --v<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>
</span></span></code></pre></div><h3 id="master节点的添加及一些注意事项">master节点的添加及一些注意事项</h3>
<p>如果需要新增master节点，需要在kubeadm配置文件中加入相关ip及dns配置，并通过如下kubeadm init phase命令重新生成相关的api server证书；</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  kubeadm init phase certs apiserver --config kubeadm.yaml 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># 重新生成cluster-info：</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  kubeadm init phase bootstrap-token
</span></span></code></pre></div><h4 id="discovery-token-ca-cert-hash-对应的值可以通过如下命令获取">discovery-token-ca-cert-hash 对应的值可以通过如下命令获取：</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2&gt;/dev/null | <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>   openssl dgst -sha256 -hex | sed <span style="color:#e6db74">&#39;s/^.* //&#39;</span>
</span></span></code></pre></div><h4 id="证书相关一些命令备忘">证书相关一些命令备忘：</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 查看证书内容：</span>
</span></span><span style="display:flex;"><span>openssl x509 -in apiserver.crt -text -noout
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 将新master的IP地址更新入证书的另一种做法：</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>openssl req -new -newkey rsa:4096 -days <span style="color:#ae81ff">3650</span> -nodes -x509 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -subj <span style="color:#e6db74">&#34;/C=US/ST=Denial/L=Springfield/O=Dis/CN=kube-apiserver&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -keyout apiserver.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -out apiserver.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -extensions SAN -config &lt;<span style="color:#f92672">(</span>echo <span style="color:#e6db74">&#34;[req]&#34;</span>; echo distinguished_name<span style="color:#f92672">=</span>req; echo <span style="color:#e6db74">&#34;[SAN]&#34;</span>; echo subjectAltName<span style="color:#f92672">=</span>IP:Load_Balancer_IP1,IP:Load_Balancer_IP2<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>openssl req -new -newkey rsa:4096 -days <span style="color:#ae81ff">3650</span> -nodes -x509 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -subj <span style="color:#e6db74">&#34;/C=US/ST=Denial/L=Springfield/O=Dis/CN=kube-apiserver&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -keyout apiserver.key <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -out apiserver.crt <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>    -extensions SAN -config &lt;<span style="color:#f92672">(</span>echo <span style="color:#e6db74">&#34;[req]&#34;</span>; echo distinguished_name<span style="color:#f92672">=</span>req; echo <span style="color:#e6db74">&#34;[SAN]&#34;</span>; echo subjectAltName<span style="color:#f92672">=</span>DNS:kubernetes,DNS:kubernetes.default,DNS:kubernetes.default.svc,DNS:kubernetes.default.svc.cluster.local,DNS:master3105,IP:10.96.0.1,IP:10.0.3.105,IP:10.0.4.212<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>此时已完成相关集群的搭建，对于跨node的通信需求，推荐安装Calico来解决；</p>
<h2 id="参考资料">参考资料</h2>
<p>参考安装流程：https://cloud.tencent.com/developer/article/1706627</p>
<p>高可用 <a href="https://zhangguanzhang.github.io/2019/03/11/k8s-ha/#/vip-%E5%8D%95%E7%82%B9%E7%9A%84%E5%9D%91%E4%B9%8B-%E2%80%93advertise-address">https://zhangguanzhang.github.io/2019/03/11/k8s-ha/#/vip-%E5%8D%95%E7%82%B9%E7%9A%84%E5%9D%91%E4%B9%8B-%E2%80%93advertise-address</a></p>
<p>安装 <a href="https://cloud.tencent.com/developer/article/2145554">https://cloud.tencent.com/developer/article/2145554</a></p>
<p>containerd <a href="https://cloud.tencent.com/developer/article/2145554">https://cloud.tencent.com/developer/article/2145554</a></p>
<p>containerd 设置文档 包含了cni <a href="https://github.com/containerd/containerd/blob/main/docs/getting-started.md">https://github.com/containerd/containerd/blob/main/docs/getting-started.md</a></p>
<p>国内环境安装 <a href="https://zhuanlan.zhihu.com/p/46341911">https://zhuanlan.zhihu.com/p/46341911</a></p>
<p>cni插件配置，参考相关文档，解决可能遇到的版本不匹配的问题：https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/migrating-from-dockershim/troubleshooting-cni-plugin-related-errors/#updating-your-cni-plugins-and-cni-config-files</p>
<p>加入master节点之前，需要手动分发证书：参考
<a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/high-availability/#manual-certs">https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/high-availability/#manual-certs</a></p>
<p>完成apiserver 证书的检查工作，并更新相关证书更新，并重新生成kube-system中的cluster-info configmap对象：参考：https://cloud.tencent.com/developer/article/1824860</p>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">最后修改于 2023-11-14</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts">
			下回<br>已经到头啦。
                </a>
                
                
                
                <a class="older-posts" href="/posts/dnat-redirect-tproxy/">
			上回<br>Dnat Redirect Tproxy
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                












<script src="https://giscus.app/client.js"
        data-repo="lixin0111/lixin0111.github.com"
        data-repo-id="MDEwOlJlcG9zaXRvcnkxNTUwOTkwOA=="
        data-category="Announcements"
        data-category-id="DIC_kwDOAOyplM4CZYux"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="preferred_color_scheme"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>

            </div>
        </div>
    </div>


                    </div>
            </div><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://www.lix23.com">
    
        <div class="nav-title">
            雪泥鸿爪
        </div>
        
        <div class="nav-subtitle">
            日拱一卒，功不唐捐
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
                
            
            
            
            <a class="a-block nav-link-item active" href="/posts">
                Archive
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/categories">
                Categories
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/tags">
                Tags
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/index.xml">
                RSS Feed
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
移植自 <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	all copyright reserved for lixin xinli80@qq.com 
	

    </div>
    
</div><div id="extraContainer" class="extra-container">
    <div class="toc-wrapper">
        

        
        <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- 目录 -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%ae%89%e8%a3%85%e8%83%8c%e6%99%af" class="nav-安装背景">
									安装背景
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%88%9d%e5%a7%8b%e5%8c%96%e8%8a%82%e7%82%b9" class="nav-初始化节点">
									初始化节点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#%e5%ae%89%e8%a3%85kubectlkubeadmkubelet-%e7%bb%84%e4%bb%b6" class="nav-安装kubectlkubeadmkubelet-组件">
									安装kubectl、kubeadm、kubelet 组件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%ae%89%e8%a3%85-containerd" class="nav-安装-containerd">
									安装 containerd
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e4%bf%ae%e6%94%b9containerd-%e4%b8%ad%e7%9a%84-sandbox-image%e9%85%8d%e7%bd%ae" class="nav-修改containerd-中的-sandbox-image配置">
									修改containerd 中的 sandbox image配置：
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e6%b7%bb%e5%8a%a0-crictl%e9%85%8d%e7%bd%ae" class="nav-添加-crictl配置">
									添加 crictl配置
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%ae%89%e8%a3%85-%e5%b9%b6%e9%85%8d%e7%bd%ae-cni-%e6%8f%92%e4%bb%b6" class="nav-安装-并配置-cni-插件">
									安装 并配置 cni 插件
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%86%85%e6%a0%b8%e5%8f%82%e6%95%b0%e9%85%8d%e7%bd%ae%e4%bf%ae%e6%94%b9" class="nav-内核参数配置修改">
									内核参数配置修改
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e9%9b%86%e7%be%a4%e5%88%9d%e5%a7%8b%e5%8c%96--%e5%8a%a0%e5%85%a5master%e8%8a%82%e7%82%b9" class="nav-集群初始化--加入master节点">
									集群初始化–加入master节点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e5%8a%a0%e5%85%a5worker%e8%8a%82%e7%82%b9" class="nav-加入worker节点">
									加入worker节点
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#master%e8%8a%82%e7%82%b9%e7%9a%84%e6%b7%bb%e5%8a%a0%e5%8f%8a%e4%b8%80%e4%ba%9b%e6%b3%a8%e6%84%8f%e4%ba%8b%e9%a1%b9" class="nav-master节点的添加及一些注意事项">
									master节点的添加及一些注意事项
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
							
								
									<ul>
								
							
						
						
							<li>
								<a href="#discovery-token-ca-cert-hash-%e5%af%b9%e5%ba%94%e7%9a%84%e5%80%bc%e5%8f%af%e4%bb%a5%e9%80%9a%e8%bf%87%e5%a6%82%e4%b8%8b%e5%91%bd%e4%bb%a4%e8%8e%b7%e5%8f%96" class="nav-discovery-token-ca-cert-hash-对应的值可以通过如下命令获取">
									discovery-token-ca-cert-hash 对应的值可以通过如下命令获取：
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#%e8%af%81%e4%b9%a6%e7%9b%b8%e5%85%b3%e4%b8%80%e4%ba%9b%e5%91%bd%e4%bb%a4%e5%a4%87%e5%bf%98" class="nav-证书相关一些命令备忘">
									证书相关一些命令备忘：
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
							
								</ul>
							
								</ul>
							
						
						
						
							<li>
								<a href="#%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" class="nav-参考资料">
									参考资料
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
        
    </div>
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top"
            :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div><div id="single-column-footer">
Hugo Theme <a href="https://github.com/amazingrise/hugo-theme-diary">Diary</a> by <a href="https://risehere.net/">Rise</a>
<br>
移植自 <a href="https://mak1t0.cc/" target="_blank" rel="noreferrer noopener">Makito</a>'s <a href="https://github.com/SumiMakito/hexo-theme-journal/" target="_blank" rel="noreferrer noopener">Journal.</a> <br>
<br>

&copy;
	
	all copyright reserved for lixin xinli80@qq.com 
	
</div>
            </div>
    
    <script src="/js/journal.js"></script></body>
</html>
